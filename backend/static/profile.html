<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrTraining - Edit Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .navbar .logo:hover {
            color: #f8f9fa;
        }

        .nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .navbar .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .navbar .username {
            color: white;
            font-weight: 500;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab-btn:hover {
            background-color: #f8f9fa;
            color: #495057;
        }

        .tab-btn.active {
            background-color: #007bff;
            color: white;
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        /* Checkbox Group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .checkbox-group label:hover {
            background-color: #f8f9fa;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }

        /* Rating Buttons */
        .rating-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rating-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .rating-item label:first-child {
            font-weight: 500;
            min-width: 150px;
            margin: 0;
        }

        .rating-buttons {
            display: flex;
            gap: 8px;
        }

        .rating-buttons input[type="radio"] {
            display: none;
        }

        .rating-buttons label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0;
            font-size: 0.9rem;
        }

        .rating-buttons label:hover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .rating-buttons input[type="radio"]:checked + label {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .container {
            margin: 2rem auto;
            padding: 0 2rem;
            display: flex;
            justify-content: center;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: fit-content;
            min-width: 600px;
            max-width: 90vw;
        }

        .card h2 {
            color: #333;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group small {
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        .status-text {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
        }

        .status-text.success {
            color: #28a745;
        }

        .status-text.error {
            color: #dc3545;
        }

        .status-text.checking {
            color: #6c757d;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .message {
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-center {
                order: 2;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .user-menu {
                order: 1;
                align-self: flex-end;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .tab-nav {
                flex-wrap: wrap;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .rating-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .rating-item label:first-child {
                min-width: auto;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="logo">üèãÔ∏è UrTraining</a>
        <div class="nav-center">
            <div class="nav-links">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/profile" class="nav-link active">Profile</a>
                <a href="/security" class="nav-link">Security</a>
                <a href="/admin" class="nav-link">Admin</a>
            </div>
        </div>
        <div class="user-menu">
            <span class="username" id="navUsername">Loading...</span>
            <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div id="message"></div>

        <div class="card">
            <h2>‚úèÔ∏è Edit Profile</h2>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button type="button" class="tab-btn active" data-tab="personal">Personal Info</button>
                <button type="button" class="tab-btn" data-tab="basic">Basic Info</button>
                <button type="button" class="tab-btn" data-tab="goals">Goals & Experience</button>
                <button type="button" class="tab-btn" data-tab="preferences">Preferences</button>
                <button type="button" class="tab-btn" data-tab="health">Health</button>
                <button type="button" class="tab-btn" data-tab="types">Training Types</button>
            </div>

            <!-- Personal Information Tab -->
            <div id="personalTab" class="tab-content">
                <h3>üë§ Personal Information</h3>
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editFullName">Full Name:</label>
                        <input type="text" id="editFullName" name="full_name" required minlength="2" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" name="email" required>
                        <small id="editEmailStatus" class="status-text"></small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Update Personal Info</button>
                        <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>

            <!-- Training Profile Form -->
            <form id="trainingProfileForm">
                <!-- Basic Information Tab -->
                <div id="basicTab" class="tab-content hidden">
                    <h3>üìä Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender">Gender:</label>
                            <select id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="age">Age:</label>
                            <input type="number" id="age" name="age" min="13" max="100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">Height (cm):</label>
                            <input type="number" id="height" name="height_cm" min="100" max="250">
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg):</label>
                            <input type="number" id="weight" name="weight_kg" min="30" max="300" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Goals & Experience Tab -->
                <div id="goalsTab" class="tab-content hidden">
                    <h3>üéØ Goals & Experience</h3>
                    <div class="form-group">
                        <label>Training Goals:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="training_goals" value="weight_loss"> Weight Loss</label>
                            <label><input type="checkbox" name="training_goals" value="muscle_gain"> Muscle Gain</label>
                            <label><input type="checkbox" name="training_goals" value="maintain_fitness"> Maintain Fitness</label>
                            <label><input type="checkbox" name="training_goals" value="improve_endurance"> Improve Endurance</label>
                            <label><input type="checkbox" name="training_goals" value="improve_flexibility"> Improve Flexibility</label>
                            <label><input type="checkbox" name="training_goals" value="competition_preparation"> Competition Preparation</label>
                            <label><input type="checkbox" name="training_goals" value="strength_building"> Strength Building</label>
                            <label><input type="checkbox" name="training_goals" value="rehabilitation"> Rehabilitation</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trainingLevel">Experience Level:</label>
                            <select id="trainingLevel" name="training_level">
                                <option value="">Select Level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="frequency">Frequency (Last 3 Months):</label>
                            <select id="frequency" name="frequency_last_3_months">
                                <option value="">Select Frequency</option>
                                <option value="not_trained">Not Trained</option>
                                <option value="1_2_times_week">1-2 Times/Week</option>
                                <option value="3_4_times_week">3-4 Times/Week</option>
                                <option value="5_6_times_week">5-6 Times/Week</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Preferences Tab -->
                <div id="preferencesTab" class="tab-content hidden">
                    <h3>‚öôÔ∏è Training Preferences</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trainingLocation">Training Location:</label>
                            <select id="trainingLocation" name="training_location">
                                <option value="">Select Location</option>
                                <option value="gym">Gym</option>
                                <option value="home">Home</option>
                                <option value="outdoor">Outdoor</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="locationDetails">Location Details:</label>
                            <select id="locationDetails" name="location_details">
                                <option value="">Select Details</option>
                                <option value="full_fitness_center">Full Fitness Center</option>
                                <option value="basic_gym">Basic Gym</option>
                                <option value="home_equipment">Home Equipment</option>
                                <option value="no_equipment">No Equipment</option>
                                <option value="park_outdoor">Park/Outdoor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sessionDuration">Session Duration:</label>
                        <select id="sessionDuration" name="session_duration">
                            <option value="">Select Duration</option>
                            <option value="15_30_min">15-30 Minutes</option>
                            <option value="30_45_min">30-45 Minutes</option>
                            <option value="45_60_min">45-60 Minutes</option>
                            <option value="60_90_min">60-90 Minutes</option>
                            <option value="90+_min">90+ Minutes</option>
                        </select>
                    </div>
                </div>

                <!-- Health Tab -->
                <div id="healthTab" class="tab-content hidden">
                    <h3>üè• Health Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="jointProblems" name="joint_back_problems">
                                Joint or Back Problems
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="chronicConditions" name="chronic_conditions">
                                Chronic Health Conditions
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="healthDetails">Health Details:</label>
                        <textarea id="healthDetails" name="health_details" rows="3" placeholder="Any specific health concerns, injuries, or medical conditions..."></textarea>
                    </div>
                </div>

                <!-- Training Types Tab -->
                <div id="typesTab" class="tab-content hidden">
                    <h3>üí™ Training Type Preferences</h3>
                    <p><small>Rate your interest level from 1 (lowest) to 5 (highest)</small></p>
                    
                    <div class="rating-group">
                        <div class="rating-item">
                            <label>Strength Training:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="strength_training" value="1" id="str1"><label for="str1">1</label>
                                <input type="radio" name="strength_training" value="2" id="str2"><label for="str2">2</label>
                                <input type="radio" name="strength_training" value="3" id="str3"><label for="str3">3</label>
                                <input type="radio" name="strength_training" value="4" id="str4"><label for="str4">4</label>
                                <input type="radio" name="strength_training" value="5" id="str5"><label for="str5">5</label>
                            </div>
                        </div>
                        
                        <div class="rating-item">
                            <label>Cardio:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="cardio" value="1" id="car1"><label for="car1">1</label>
                                <input type="radio" name="cardio" value="2" id="car2"><label for="car2">2</label>
                                <input type="radio" name="cardio" value="3" id="car3"><label for="car3">3</label>
                                <input type="radio" name="cardio" value="4" id="car4"><label for="car4">4</label>
                                <input type="radio" name="cardio" value="5" id="car5"><label for="car5">5</label>
                            </div>
                        </div>
                        
                        <div class="rating-item">
                            <label>HIIT:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="hiit" value="1" id="hiit1"><label for="hiit1">1</label>
                                <input type="radio" name="hiit" value="2" id="hiit2"><label for="hiit2">2</label>
                                <input type="radio" name="hiit" value="3" id="hiit3"><label for="hiit3">3</label>
                                <input type="radio" name="hiit" value="4" id="hiit4"><label for="hiit4">4</label>
                                <input type="radio" name="hiit" value="5" id="hiit5"><label for="hiit5">5</label>
                            </div>
                        </div>
                        
                        <div class="rating-item">
                            <label>Yoga/Pilates:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="yoga_pilates" value="1" id="yoga1"><label for="yoga1">1</label>
                                <input type="radio" name="yoga_pilates" value="2" id="yoga2"><label for="yoga2">2</label>
                                <input type="radio" name="yoga_pilates" value="3" id="yoga3"><label for="yoga3">3</label>
                                <input type="radio" name="yoga_pilates" value="4" id="yoga4"><label for="yoga4">4</label>
                                <input type="radio" name="yoga_pilates" value="5" id="yoga5"><label for="yoga5">5</label>
                            </div>
                        </div>
                        
                        <div class="rating-item">
                            <label>Functional Training:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="functional_training" value="1" id="func1"><label for="func1">1</label>
                                <input type="radio" name="functional_training" value="2" id="func2"><label for="func2">2</label>
                                <input type="radio" name="functional_training" value="3" id="func3"><label for="func3">3</label>
                                <input type="radio" name="functional_training" value="4" id="func4"><label for="func4">4</label>
                                <input type="radio" name="functional_training" value="5" id="func5"><label for="func5">5</label>
                            </div>
                        </div>
                        
                        <div class="rating-item">
                            <label>Stretching:</label>
                            <div class="rating-buttons">
                                <input type="radio" name="stretching" value="1" id="stretch1"><label for="stretch1">1</label>
                                <input type="radio" name="stretching" value="2" id="stretch2"><label for="stretch2">2</label>
                                <input type="radio" name="stretching" value="3" id="stretch3"><label for="stretch3">3</label>
                                <input type="radio" name="stretching" value="4" id="stretch4"><label for="stretch4">4</label>
                                <input type="radio" name="stretching" value="5" id="stretch5"><label for="stretch5">5</label>
                            </div>
                        </div>
                    </div>
                </div>

                                    <div class="form-actions" id="trainingActions" style="display: none;">
                        <button type="submit" class="btn btn-primary">Update Training Profile</button>
                        <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                    </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let originalEmail = '';
        let trainingProfile = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
                    const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
                return;
            }

            try {
                // First get user basic info
                const userResponse = await fetch('http://localhost:8000/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!userResponse.ok) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/';
                    return;
                }

                const userData = await userResponse.json();
                currentUser = userData.user_info;

                // Then get training profile
                const trainingResponse = await fetch('http://localhost:8000/auth/training-profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (trainingResponse.ok) {
                    const trainingData = await trainingResponse.json();
                    trainingProfile = trainingData.training_profile;
                } else {
                    trainingProfile = null;
                }
                
                // Update navbar username
                const navUsername = document.getElementById('navUsername');
                if (navUsername) {
                    navUsername.textContent = currentUser.full_name || currentUser.email || 'User';
                }
                
                populatePersonalForm();
                populateTrainingForm();
                setupTabs();
            } catch (error) {
                console.error('Error fetching user data:', error);
                localStorage.removeItem('authToken');
                window.location.href = '/';
            }
        });



        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const trainingActions = document.getElementById('trainingActions');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update button states
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update content visibility
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const targetContent = document.getElementById(targetTab + 'Tab');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                    
                    // Show/hide training form actions
                    if (targetTab === 'personal') {
                        trainingActions.style.display = 'none';
                    } else {
                        trainingActions.style.display = 'flex';
                    }
                });
            });
        }

        function populatePersonalForm() {
            document.getElementById('editFullName').value = currentUser.full_name || '';
            document.getElementById('editEmail').value = currentUser.email || '';
            originalEmail = currentUser.email || '';
        }

        function populateTrainingForm() {
            if (!trainingProfile) return;

            const basicInfo = trainingProfile.basic_information || {};
            const goals = trainingProfile.training_goals || [];
            const experience = trainingProfile.training_experience || {};
            const preferences = trainingProfile.preferences || {};
            const health = trainingProfile.health || {};
            const types = trainingProfile.training_types || {};

            console.log('Populating form with training profile:', trainingProfile); // Debug log

            // Basic Info
            document.getElementById('gender').value = basicInfo.gender || '';
            document.getElementById('age').value = basicInfo.age || '';
            document.getElementById('height').value = basicInfo.height_cm || '';
            document.getElementById('weight').value = basicInfo.weight_kg || '';

            // Goals & Experience
            // Clear all checkboxes first
            document.querySelectorAll('input[name="training_goals"]').forEach(cb => cb.checked = false);
            if (goals.length > 0) {
                goals.forEach(goal => {
                    const checkbox = document.querySelector(`input[name="training_goals"][value="${goal}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            document.getElementById('trainingLevel').value = experience.level || '';
            document.getElementById('frequency').value = experience.frequency_last_3_months || '';

            // Preferences
            document.getElementById('trainingLocation').value = preferences.training_location || preferences.location || '';
            document.getElementById('locationDetails').value = preferences.location_details || '';
            document.getElementById('sessionDuration').value = preferences.session_duration || '';

            // Health - Check both nested and flat structures
            console.log('Health data:', health); // Debug log
            document.getElementById('jointProblems').checked = health.joint_back_problems || false;
            document.getElementById('chronicConditions').checked = health.chronic_conditions || false;
            document.getElementById('healthDetails').value = health.health_details || '';

            // Training Types - Clear all radio buttons first
            const trainingTypes = ['strength_training', 'cardio', 'hiit', 'yoga_pilates', 'functional_training', 'stretching'];
            trainingTypes.forEach(type => {
                document.querySelectorAll(`input[name="${type}"]`).forEach(radio => radio.checked = false);
                const value = types[type];
                if (value) {
                    const radio = document.querySelector(`input[name="${type}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                }
            });
        }

        // Email availability checking
        let emailCheckTimeout;
        document.getElementById('editEmail').addEventListener('input', function() {
            const email = this.value.trim();
            const statusElement = document.getElementById('editEmailStatus');
            
            // Clear previous timeout
            clearTimeout(emailCheckTimeout);
            
            if (!email || email === originalEmail) {
                statusElement.textContent = '';
                statusElement.className = 'status-text';
                return;
            }
            
            // Debounce the API call
            emailCheckTimeout = setTimeout(async () => {
                try {
                    const authToken = localStorage.getItem('authToken');
                    const response = await fetch(`http://localhost:8000/auth/check-email-availability?email=${encodeURIComponent(email)}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    
                    if (data.available) {
                        statusElement.textContent = '‚úì Email available';
                        statusElement.className = 'status-text success';
                    } else {
                        statusElement.textContent = '‚úó Email already taken';
                        statusElement.className = 'status-text error';
                    }
                } catch (error) {
                    console.error('Error checking email:', error);
                    statusElement.textContent = '';
                    statusElement.className = 'status-text';
                }
            }, 500);
        });

        // Handle personal profile form submission
        document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Validate email availability if changed
            const email = data.email.trim();
            if (email !== originalEmail) {
                const statusElement = document.getElementById('editEmailStatus');
                if (statusElement.classList.contains('error')) {
                    alert('Please choose a different email address.');
                    return;
                }
            }
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';
            submitButton.disabled = true;
            
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8000/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const updatedData = await response.json();
                    currentUser = updatedData.user_info;
                    originalEmail = currentUser.email;
                    alert('Personal information updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert('Error updating profile: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        // Handle training profile form submission
        document.getElementById('trainingProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {};
            
            // Collect all form data manually to ensure we get all fields
            
            // Basic Information
            const gender = document.getElementById('gender').value.trim();
            const age = document.getElementById('age').value.trim();
            const height = document.getElementById('height').value.trim();
            const weight = document.getElementById('weight').value.trim();
            
            data.gender = gender || null;
            data.age = age ? parseInt(age) : null;
            data.height_cm = height ? parseInt(height) : null;
            data.weight_kg = weight ? parseFloat(weight) : null;
            
            // Training Goals (checkboxes)
            const goalCheckboxes = document.querySelectorAll('input[name="training_goals"]:checked');
            data.training_goals = Array.from(goalCheckboxes).map(cb => cb.value);
            
            // Experience
            const trainingLevel = document.getElementById('trainingLevel').value.trim();
            const frequency = document.getElementById('frequency').value.trim();
            
            data.training_level = trainingLevel || null;
            data.frequency_last_3_months = frequency || null;
            
            // Preferences
            const trainingLocation = document.getElementById('trainingLocation').value.trim();
            const locationDetails = document.getElementById('locationDetails').value.trim();
            const sessionDuration = document.getElementById('sessionDuration').value.trim();
            
            data.training_location = trainingLocation || null;
            data.location_details = locationDetails || null;
            data.session_duration = sessionDuration || null;
            
            // Health Information
            data.joint_back_problems = document.getElementById('jointProblems').checked;
            data.chronic_conditions = document.getElementById('chronicConditions').checked;
            
            const healthDetails = document.getElementById('healthDetails').value.trim();
            data.health_details = healthDetails || null;
            
            // Training Types (radio buttons)
            const trainingTypes = ['strength_training', 'cardio', 'hiit', 'yoga_pilates', 'functional_training', 'stretching'];
            trainingTypes.forEach(type => {
                const selectedRadio = document.querySelector(`input[name="${type}"]:checked`);
                data[type] = selectedRadio ? parseInt(selectedRadio.value) : null;
            });
            
            console.log('Sending training profile data:', data); // Debug log
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';
            submitButton.disabled = true;
            
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8000/auth/training-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const updatedData = await response.json();
                    trainingProfile = updatedData.training_profile;
                    alert('Training profile updated successfully!');
                    
                    // Refresh the form with updated data
                    populateTrainingForm();
                } else {
                    const errorData = await response.json();
                    console.error('Server error:', errorData); // Debug log
                    alert('Error updating training profile: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating training profile:', error);
                alert('Error updating training profile. Please try again.');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                window.location.href = '/';
            }
        });
    </script>
</body>
</html> 